<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>壁纸引擎媒体库 | WSML</title>
    <link rel="icon" type="image/png" href="/public/icon-192.png">
    <style>
        :root {
            --bg-color: #141414; --card-bg: #1f1f1f; --text-color: #e5e5e5;
            --text-secondary-color: #8c8c8c; --hover-bg: #333; --accent-color: #e50914; --drive-mode-color: #0632BD;
            --dialog-bg: rgba(0, 0, 0, 0.85); --tag-bg: #4d4d4d; --tag-active-bg: var(--drive-mode-color);
            --status-bg: #222;
        }
        body { font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background-color: var(--bg-color); color: var(--text-color); margin: 0; padding: 0; }
        .hidden { display: none !important; }

        /* Welcome Screen Styles */
        #welcome-screen { text-align: center; padding-top: 10vh; }
        #welcome-screen h1 { font-size: 3em; color: var(--drive-mode-color); }
        #welcome-screen p { font-size: 1.2em; color: var(--text-secondary-color); }
        .drive-grid { display: flex; justify-content: center; flex-wrap: wrap; gap: 30px; margin-top: 50px; }
        .drive-card { background: var(--card-bg); border-radius: 8px; padding: 25px; width: 220px; cursor: pointer; transition: all 0.2s ease; border: 2px solid transparent; }
        .drive-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--drive-mode-color); }
        .drive-letter { font-size: 3.5em; font-weight: bold; }
        .drive-stats { text-align: left; margin-top: 15px; color: var(--text-secondary-color); font-size: 0.9em; }
        .progress-bar { background-color: #444; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
        .progress-bar-inner { background-color: var(--drive-mode-color); height: 100%; }

        /* Main App Styles */
        .container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px; }
        .header h1 { font-size: 2em; margin: 0; color: var(--text-color); }
        #speed-mode-btn {font-weight: bold;border-radius: 20px;padding: 8px 16px;border: none;cursor: pointer;transition: background-color 0.3s, color 0.3s;font-size: 1em;}
        #speed-mode-btn.normal-speed {background-color: var(--drive-mode-color); color: white;}
        #speed-mode-btn.over-speed {background-color: var(--accent-color); color: white;}
        .header-controls button, .controls select, .controls input { background: var(--card-bg); color: var(--text-color); border: 1px solid var(--hover-bg); padding: 8px 12px; border-radius: 4px; font-size: 1em; margin-left: 10px; vertical-align: middle; cursor: pointer; }
        .header-controls button:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .status-panel { background-color: var(--status-bg); border-radius: 8px; padding: 15px 20px; margin-bottom: 20px; font-size: 0.9em; color: var(--text-secondary-color); display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 10px 20px; }
        .status-panel span { color: var(--text-color); }
        .status-path, .status-visitors { grid-column: 1 / -1; word-break: break-all; } /* Span full width */
        .status-visitors .tag { margin-right: 8px; vertical-align: middle; }

        .tags-filter { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 8px; }
        .tag { background-color: var(--tag-bg); padding: 5px 12px; border-radius: 15px; font-size: 0.9em; cursor: pointer; transition: background-color 0.2s; user-select: none; display: inline-block;}
        .tag.active { background-color: var(--drive-mode-color); font-weight: bold; }
        .group-container h2 { font-size: 1.5em; border-bottom: 2px solid var(--hover-bg); padding-bottom: 10px; margin-top: 40px; margin-bottom: 20px; }
        .wallpaper-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px; }
        
        .card { background-color: var(--card-bg); border-radius: 6px; overflow: hidden; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column; height: 160px; position: relative; }
        .card:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card-content { padding: 15px; flex-grow: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .card-title { font-weight: bold; text-align: center; margin-bottom: 10px; font-size: 1.1em; }
        .card-tags { display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .card-tags .tag { font-size: 0.8em; padding: 3px 8px; cursor: default; }
        .card-play-count { position: absolute; bottom: 8px; right: 12px; font-size: 0.8em; color: var(--text-secondary-color); background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; }
        .card-progress-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 5px; background-color: rgba(255,255,255,0.1); }
        .card-progress-bar-inner { height: 100%; background-color: var(--drive-mode-color); }
        
        .skeleton { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; } @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .skeleton .card { background-color: #2a2a2a; } .skeleton .card-title, .skeleton .card-tags { background-color: #444; border-radius: 4px; }
        .skeleton .card-title { height: 20px; width: 70%; margin-bottom: 15px; } .skeleton .card-tags { height: 15px; width: 50%; }
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--dialog-bg); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .dialog-overlay.visible { opacity: 1; visibility: visible; } 
        .dialog-content {position: relative;display: flex;justify-content: center;align-items: center;}
        #player {max-width: 90vw;max-height: 90vh;width: auto;height: auto;border-radius: 6px;box-shadow: 0 0 50px rgba(0, 0, 0, 0.7);}
        .close-btn { position: absolute; top: -45px; right: -10px; font-size: 2.5em; color: #fff; cursor: pointer; line-height: 1; user-select: none; }
    </style>
</head>
<body>

    <div id="welcome-screen">
        <img src="/public/icon-192-maskable.png" alt="壁纸引擎媒体库" style="height: 100px;">
        <a href="https://github.com/MindMobius/WallpaperEngineMediaLibrary" target="_blank" style="color: var(--text-color); text-decoration: none; font-weight: small; display: block; margin-top: 10px;">
            <img src="/public/github-mark-white.svg" alt="GitHub" style="height: 1.2em; vertical-align: -0.2em; margin-right: 5px;">
            MindMobius/WallpaperEngineMediaLibrary
        </a>
        <h1>欢迎使用壁纸引擎媒体库</h1>
        <p>开始使用前, 请选择您的 Steam 安装的硬盘</p>
        <div class="drive-grid" id="drive-grid-container"></div>
    </div>

    <div id="main-app" class="hidden">
        <div class="container">
            <div class="header">
                <div style="display: flex; flex-direction: column; align-items: flex-start; gap: 10px;">
                    <div style="display: flex; align-items: center; gap: 20px;">
                        <h1>
                            <img src="/public/icon-192-maskable.png" alt="logo" style="height: 1.2em; vertical-align: -0.2em; margin-right: 10px;">
                            壁纸引擎媒体库 | WSML
                        </h1>
                        <button id="speed-mode-btn" class="normal-speed">一键超速</button>
                    </div>
                    <a href="https://github.com/MindMobius/WallpaperEngineMediaLibrary" target="_blank" style="color: var(--text-color); text-decoration: none; font-weight: small; display: block;">
                        <img src="/public/github-mark-white.svg" alt="GitHub" style="height: 1.2em; vertical-align: -0.2em; margin-right: 5px;">
                        MindMobius/WallpaperEngineMediaLibrary
                    </a>
                </div>

                <div class="header-controls">
                    <div class="controls" style="display: inline-block;">
                        <label>排序:</label>
                        <select id="sort-by"><option value="date">时间</option><option value="title">名称</option></select>
                        <select id="sort-order"><option value="desc">倒序</option><option value="asc">正序</option></select>
                        <label>分组:</label>
                        <input type="checkbox" id="group-by-date" checked>
                    </div>
                    <button id="refresh-btn">
                        <i class="fas fa-sync"></i> 刷新
                    </button>
                    <button id="change-drive-btn">更换盘符</button>
                </div>
            </div>
            
            <div class="status-panel">
                <div class="status-path">扫描路径: <span id="status-path">...</span></div>
                <div>本机地址: <span id="status-local-url">...</span></div>
                <div>局域网地址: <span id="status-lan-url">...</span></div>
                <div>项目数量: <span id="status-count">...</span></div>
                <div>最后刷新: <span id="status-time">...</span></div>
                <div class="status-visitors">访客IP: <span id="status-visitors">...</span></div>
            </div>

            <div class="tags-filter" id="tags-filter-container"></div>
            <div id="content-area"></div>
        </div>
    </div>

    <div class="dialog-overlay" id="player-dialog">
        <div class="dialog-content">
            <span class="close-btn" id="close-player-btn">×</span>
            <video id="player" controls autoplay loop playsinline></video>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- ELEMENT SELECTORS ---
    const welcomeScreen = document.getElementById('welcome-screen');
    const mainApp = document.getElementById('main-app');
    const driveGridContainer = document.getElementById('drive-grid-container');
    const contentArea = document.getElementById('content-area');
    const tagsFilterContainer = document.getElementById('tags-filter-container');
    const playerDialog = document.getElementById('player-dialog');
    const videoElement = document.getElementById('player');
    const refreshBtn = document.getElementById('refresh-btn');
    
    // --- GLOBAL STATE ---
    let allWallpapers = [], allTags = [], activeTag = '所有', autoRefreshInterval = null;
    let speedMode = 'normal'; // vvv 新增状态: normal 或 overspeed vvv

    // --- API UTILITY ---
    const api = { 
        get: async (url) => (await fetch(url)).json(), 
        post: async (url, data = {}) => (await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(data) })).json() 
    };
    
    // --- RENDER FUNCTIONS (Corrected and complete) ---
    function renderDrives(drives) {
        driveGridContainer.innerHTML = '';
        drives.forEach(drive => {
            const card = document.createElement('div');
            card.className = 'drive-card';
            card.onclick = () => selectDrive(drive.letter);

            if (drive.letter === 'auto') {
                card.innerHTML = `
                <div class="drive-letter">AUTO</div>
                <div class="drive-stats">
                    <div>自动检测 Steam 库</div>
                    <div>无需手动选择盘符</div>
                </div>
            `;
            } else {
                card.innerHTML = `
                <div class="drive-letter">${drive.letter}</div>
                <div class="drive-stats">
                    <div>总空间: ${drive.total}</div>
                    <div>已使用: ${drive.used}</div>
                    <div>剩余: ${drive.free}</div>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" style="width: ${drive.percent}%;"></div>
                    </div>
                </div>
            `;
            }
            driveGridContainer.appendChild(card);
        });
    }

    function renderSkeleton() {
        welcomeScreen.classList.add('hidden');
        mainApp.classList.remove('hidden');
        contentArea.innerHTML = '';
        const grid = document.createElement('div');
        grid.className = 'wallpaper-grid skeleton';
        for (let i = 0; i < 12; i++) {
            grid.innerHTML += `
                <div class="card">
                    <div class="card-content">
                        <div class="card-title"></div>
                        <div class="card-tags"></div>
                    </div>
                </div>`;
        }
        contentArea.appendChild(grid);
    }
    
    function renderTagsFilter() {
        tagsFilterContainer.innerHTML = '';
        const tags = ['所有', ...allTags];
        tags.forEach(tag => {
            const tagEl = document.createElement('div');
            tagEl.className = 'tag';
            tagEl.textContent = tag;
            if (tag === activeTag) tagEl.classList.add('active');
            tagEl.onclick = () => { 
                activeTag = tag; 
                document.querySelectorAll('.tags-filter .tag').forEach(el => el.classList.remove('active')); 
                tagEl.classList.add('active'); 
                applyFiltersAndRender(); 
            };
            tagsFilterContainer.appendChild(tagEl);
        });
    }
    
    function createCard(wp) {
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.id = wp.id; // 只保留 data-id，事件由父容器统一处理
    
    const tagsHtml = wp.tags.slice(0, 3).map(tag => `<span class="tag">${tag}</span>`).join('');
    const playCountHtml = wp.playCount > 0 ? `<div class="card-play-count">次数: ${wp.playCount}</div>` : '';
    const progressBarHtml = wp.progress > 0.01 ? `<div class="card-progress-bar"><div class="card-progress-bar-inner" style="width: ${wp.progress * 100}%;"></div></div>` : '';
    
    card.innerHTML = `<div class="card-content"><div class="card-title">${wp.title}</div><div class="card-tags">${tagsHtml}</div></div>${playCountHtml}${progressBarHtml}`;
    return card;
}
    
    function renderWallpapers(wallpapersToRender) {
        contentArea.innerHTML = '';
        if (wallpapersToRender.length === 0) {
            contentArea.innerHTML = '<div style="text-align:center;font-size:1.2em;">没有匹配的壁纸。</div>';
            return;
        }
        const groupByDate = document.getElementById('group-by-date').checked && document.getElementById('sort-by').value === 'date';
        if (groupByDate) {
            const groups = wallpapersToRender.reduce((acc, wp) => {
                (acc[wp.date] = acc[wp.date] || []).push(wp);
                return acc;
            }, {});
            for (const date in groups) {
                const groupContainer = document.createElement('div');
                groupContainer.innerHTML = `<h2>${date}</h2>`;
                const grid = document.createElement('div');
                grid.className = 'wallpaper-grid';
                groups[date].forEach(wp => grid.appendChild(createCard(wp)));
                groupContainer.appendChild(grid);
                contentArea.appendChild(groupContainer);
            }
        } else {
            const grid = document.createElement('div');
            grid.className = 'wallpaper-grid';
            wallpapersToRender.forEach(wp => grid.appendChild(createCard(wp)));
            contentArea.appendChild(grid);
        }
    }
    
    // --- LOGIC & EVENT HANDLERS ---
    async function updateStatusPanel() {
        const status = await api.get('/api/status');
        document.getElementById('status-path').textContent = status.scan_path;
        document.getElementById('status-local-url').textContent = status.local_address;
        document.getElementById('status-lan-url').textContent = status.lan_address;
        document.getElementById('status-count').textContent = status.item_count;
        document.getElementById('status-time').textContent = status.last_refresh;
        const visitorsContainer = document.getElementById('status-visitors');
        visitorsContainer.innerHTML = ''; // Clear previous
        (status.visitors || []).forEach(ip => {
            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = ip;
            visitorsContainer.appendChild(tag);
        });
    }

    async function handleRefresh(isAuto = false) {
        if (!isAuto) {
            refreshBtn.disabled = true;
            refreshBtn.textContent = '刷新中...';
        }
        try {
            const response = await api.post('/api/refresh');
            if (response.status !== 'success') throw new Error(response.message);
            await initializeMainApp(false);
        } catch (error) {
            if (!isAuto) alert(`刷新失败: ${error.message}`);
            else console.error("Auto-refresh failed:", error.message);
        } finally {
            if (!isAuto) {
                refreshBtn.disabled = false;
                refreshBtn.textContent = '刷新';
            }
        }
    }
    
    async function selectDrive(driveLetter) {
        renderSkeleton();
        const response = await api.post('/api/select-drive', { drive: driveLetter });
        if (response.status === 'success') { await initializeMainApp(); }
        else { alert(`选择盘符时出错: ${response.message}`); location.reload(); }
    }
    
    function applyFiltersAndRender() {
        let filteredWallpapers = allWallpapers;

        // vvv 简化的过滤逻辑 vvv
        // 1. Filter by speed mode
        // 后端已经帮我们分好类了，所以这里直接比较即可
        filteredWallpapers = filteredWallpapers.filter(wp => wp.rating === speedMode);
        // ^^^ 简化的过滤逻辑 ^^^

        // 2. Filter by tag
        if (activeTag !== '所有') {
            filteredWallpapers = filteredWallpapers.filter(wp => wp.tags.includes(activeTag));
        }

        // 3. Sort (保持不变)
        const sortBy = document.getElementById('sort-by').value;
        const isDesc = document.getElementById('sort-order').value === 'desc';
        filteredWallpapers.sort((a, b) => {
            let valA = sortBy === 'title' ? a.title.toLowerCase() : a.mtime;
            let valB = sortBy === 'title' ? b.title.toLowerCase() : b.mtime;
            if (valA < valB) return isDesc ? 1 : -1;
            if (valA > valB) return isDesc ? -1 : 1;
            return 0;
        });

        renderWallpapers(filteredWallpapers);
    }
    
    function openPlayer(wp) {
        playerDialog.dataset.videoId = wp.id;
        api.post('/api/update-history', { id: wp.id, incrementPlayCount: true });
        videoElement.src = `/api/video/${wp.id}`;
        playerDialog.classList.add('visible');
        videoElement.play().catch(e => console.error("播放失败:", e));
        
        wp.playCount += 1;
        const cardInDom = document.querySelector(`.card[data-id="${wp.id}"]`);
        if (cardInDom) {
            let countEl = cardInDom.querySelector('.card-play-count');
            if (!countEl) {
                countEl = document.createElement('div');
                countEl.className = 'card-play-count';
                cardInDom.appendChild(countEl);
            }
            countEl.textContent = `次数: ${wp.playCount}`;
        }
    }

    function closePlayer() {
        const id = playerDialog.dataset.videoId;
        if (!id) return;
        const progress = videoElement.duration ? videoElement.currentTime / videoElement.duration : 0;
        if (progress > 0.01) { api.post('/api/update-history', { id: id, progress: progress }); }
        
        playerDialog.classList.remove('visible');
        videoElement.pause();
        videoElement.src = '';
        playerDialog.dataset.videoId = '';
        
        handleRefresh(true);
    }

    function startAutoRefresh() {
        if (autoRefreshInterval) clearInterval(autoRefreshInterval);
        autoRefreshInterval = setInterval(() => handleRefresh(true), 5000);
    }

    function handleSpeedModeChange() {
        const speedBtn = document.getElementById('speed-mode-btn');
        const root = document.documentElement; // 获取HTML根元素

        if (speedMode === 'normal') {
            if (confirm('请在安全环境下超速！\n\n您确定要进入超速模式吗？')) {
                speedMode = 'overspeed';
                speedBtn.textContent = '退出超速';
                speedBtn.className = 'over-speed';
                // vvv 修改CSS变量为红色 vvv
                root.style.setProperty('--drive-mode-color', 'var(--accent-color)');
            } else {
                return;
            }
        } else {
            speedMode = 'normal';
            speedBtn.textContent = '一键超速';
            speedBtn.className = 'normal-speed';
            // vvv 修改CSS变量为蓝色 vvv
            root.style.setProperty('--drive-mode-color', '#0632BD');
        }
        applyFiltersAndRender();
    }

    async function fetchMainData() {
        const data = await api.get('/api/data');
        allWallpapers = data.wallpapers;
        allTags = data.tags;
        renderTagsFilter();
        applyFiltersAndRender();
    }

    async function initializeMainApp(showSkeleton = true) {
        if (showSkeleton) {
            welcomeScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
        }
        await Promise.all([fetchMainData(), updateStatusPanel()]);
        startAutoRefresh();
    }
    
    async function initializeWelcomeScreen() {
        const drives = await api.get('/api/drives');
        mainApp.classList.add('hidden');
        welcomeScreen.classList.remove('hidden');
        renderDrives(drives);
    }

    async function main() {
        document.documentElement.style.setProperty('--drive-mode-color', '#0632BD');
        const config = await api.get('/api/config-status');
        if (config.configured) { await initializeMainApp(); }
        else { await initializeWelcomeScreen(); }
    }

    // --- EVENT BINDING ---
    document.querySelectorAll('#sort-by, #sort-order, #group-by-date').forEach(el => el.addEventListener('change', applyFiltersAndRender));
    document.getElementById('change-drive-btn').addEventListener('click', async () => { if (confirm('您确定要更换盘符吗? 这会清除当前的选择。')) { await api.post('/api/reset-config'); location.reload(); } });
    refreshBtn.addEventListener('click', () => handleRefresh(false));
    contentArea.addEventListener('click', e => { const card = e.target.closest('.card'); if (card && card.dataset.id) { const wp = allWallpapers.find(w => w.id === card.dataset.id); if (wp) openPlayer(wp); } });
    document.getElementById('close-player-btn').addEventListener('click', closePlayer);
    document.getElementById('speed-mode-btn').addEventListener('click', handleSpeedModeChange);
    playerDialog.addEventListener('click', e => { if (e.target === playerDialog) closePlayer(); });
    
    main();
});
</script>
</body>
</html>